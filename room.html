<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Group Chat Room</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
    <div class="container">
        <div class="container">
            <h2 class="mt-3">Group Chat - Room <span id="roomIdDisplay"></span> <button class="btn btn-info btn-sm ml-3"
                    id="copyLink">Copy Link</button>
            </h2>
            <button class="btn btn-danger btn-sm ml-3" id="userCount" disabled>User Count: 0</button>
            <button class="btn btn-danger btn-sm ml-3" id="cancelRoom">Cancel Room</button>
            <div class="alert alert-success d-none mt-2" id="copySuccess">Link copied!</div>
            <div class="alert alert-info mt-2" id="userJoinMessage" style="display: none;"></div>
        </div>

        <div class="card mt-3">
            <div class="card-body" style="height: 400px; overflow-y: scroll;">
                <ul class="list-group" id="messages-list"></ul>
            </div>
            <div class="card-footer">
                <textarea class="form-control" id="message" placeholder="Type your message"></textarea>
                <input type="file" class="form-control mt-2" id="fileInput">
                <button class="btn btn-primary mt-2" id="send">Send</button>
            </div>
        </div>
    </div>

    <script>
        let socket = io();
        let roomId = window.location.pathname.split("/").pop();
        $('#roomIdDisplay').text(roomId);

        socket.emit('joinRoom', roomId);

        $('#send').click(function () {
            let message = $('#message').val();
            let file = $('#fileInput')[0].files[0];

            $('#message').val('');
            $('#fileInput').val('');

            let now = new Date();
            let dateTime = now.toISOString().split('T')[0] + " " +
                (now.getHours() % 12 || 12) + ":" + now.getMinutes().toString().padStart(2, '0') + " " +
                (now.getHours() >= 12 ? 'PM' : 'AM');

            if (file) {
                let reader = new FileReader();
                reader.onload = function (event) {
                    socket.emit('chat', {
                        roomId: roomId,
                        message: message,
                        fileName: file.name,
                        fileType: file.type,
                        fileData: event.target.result.split(',')[1],
                        dateTime: dateTime
                    });
                };
                reader.readAsDataURL(file);
            } else {
                socket.emit('chat', { roomId: roomId, message: message, dateTime: dateTime });
            }

            let fileHTML = file ? `<a href="#" class="btn btn-sm btn-info mt-1">attachment - ${file.name}</a>` : "";
            $("#messages-list").prepend(`
                <li class="list-group-item">
                    <div><h3>You - ${message}</h3></div>
                    ${fileHTML}
                    <small class="text-muted d-block mt-1">${dateTime}</small>
                </li>
            `);

            $(".card-body").scrollTop(0);
        });

        socket.on('chat', function (data) {
            let fileHTML = data.fileName ? `<a href="data:${data.fileType};base64,${data.fileData}" download="${data.fileName}" class="btn btn-sm btn-info mt-1">Download ${data.fileName}</a>` : "";

            $("#messages-list").prepend(`
                <li class="list-group-item">
                    <div><h3>Other's - ${data.message}</h3></div>
                    ${fileHTML}
                    <small class="text-muted d-block mt-1">${data.dateTime}</small>
                </li>
            `);

            $(".card-body").scrollTop(0);
        });

        $('#copyLink').click(function () {
            let roomLink = window.location.href;
            navigator.clipboard.writeText(roomLink).then(() => {
                $('#copySuccess').removeClass('d-none');
                setTimeout(() => $('#copySuccess').addClass('d-none'), 3000);
            }).catch(err => {
                console.error("Failed to copy: ", err);
            });
        });

        $('#cancelRoom').click(function () {
            if (confirm("Are you sure you want to cancel this room?")) {
                socket.emit('cancelRoom', roomId);
            }
        });

        // Listen for room cancellation from server
        socket.on('roomCanceled', function (message) {
            alert(message);
            window.location.href = '/';
        });

        // Listen for user joining notification and update the user count
        socket.on('userJoined', function (data) {
            $('#userJoinMessage').text(data.message).show();
            $('#userCount').text(`User Count: ${data.userCount}`);
            setTimeout(() => {
                $('#userJoinMessage').hide();
            }, 2000);
        });

        // Listen for user joining notification and update the user count
        socket.on('userLeft', function (data) {
            $('#userJoinMessage').text(data.message).show();
            $('#userCount').text(`User Count: ${data.userCount}`);
            setTimeout(() => {
                $('#userJoinMessage').hide();
            }, 2000);
        });

    </script>
</body>

</html>