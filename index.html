<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Group Chat App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 mt-2">
                <div class="card">
                    <div class="card-header">Group Chat</div>
                    <div class="card-body" style="height: 500px; overflow-y: scroll;">
                        <ul class="list-group">
                            <li class="list-group-item">Welcome to Group Chat</li>
                        </ul>
                        <ul class="list-group mt-1" id="messages-list"></ul>
                    </div>
                    <div class="card-footer">
                        <textarea class="form-control" placeholder="Type your message" id="message"></textarea>
                        <input type="file" class="form-control mt-2" id="fileInput">
                        <button class="btn btn-primary btn-block mt-2" id="send">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = io();

        $('#send').click(function () {
            let message = $('#message').val();
            let file = $('#fileInput')[0].files[0];

            $('#message').val('');
            $('#fileInput').val('');

            let now = new Date();
            let dateTime = now.toISOString().split('T')[0] + " " +
                (now.getHours() % 12 || 12) + ":" + now.getMinutes().toString().padStart(2, '0') + " " +
                (now.getHours() >= 12 ? 'PM' : 'AM');

            if (file) {
                let reader = new FileReader();
                reader.onload = function (event) {
                    socket.emit('chat', {
                        message: message,
                        fileName: file.name,
                        fileType: file.type,
                        fileData: event.target.result.split(',')[1], // Get base64 data
                        dateTime: dateTime
                    });
                };
                reader.readAsDataURL(file);
            } else {
                socket.emit('chat', { message: message, dateTime: dateTime });
            }

            let fileHTML = file ? `<a href="#" class="btn btn-sm btn-info mt-1" onclick="downloadFile('${file.name}', '${file.type}', '${file}');">attachment -  ${file.name}</a>` : "";

            $("#messages-list").append(`
                <li class="list-group-item">
                    <div><h3>You - ${message}</h3></div>
                    ${fileHTML}
                    <small class="text-muted d-block mt-1">${dateTime}</small>
                </li>
            `);
        });

        socket.on('chat', function (data) {
            let fileHTML = data.fileName ? `<a href="data:${data.fileType};base64,${data.fileData}" download="${data.fileName}" class="btn btn-sm btn-info mt-1">Download ${data.fileName}</a>` : "";

            $("#messages-list").append(`
                <li class="list-group-item">
                    <div><h3>Other's - ${data.message}</h3></div>
                    ${fileHTML}
                    <small class="text-muted d-block mt-1">${data.dateTime}</small>
                </li>
            `);
        });
    </script>
</body>

</html>